# GitHub Copilot CLI Automation Action
# Reusable workflow that installs and runs GitHub Copilot CLI with configurable prompts
#
# Usage:
#   jobs:
#     copilot-analysis:
#       uses: ./.github/workflows/copilot-cli-action.yml
#       with:
#         agent: "security-analysis"
#         user_prompt: "Review the code for vulnerabilities"
#       secrets: inherit

name: Copilot CLI Automation

on:
  workflow_call:
    inputs:
      agent:
        description: 'Name of the built-in agent to use (e.g., code-review, security-analysis, documentation-generation)'
        required: false
        type: string
        default: ''
      agent_file:
        description: 'Path to a custom .agent.md file (alternative to using a built-in agent)'
        required: false
        type: string
        default: ''
      user_prompt:
        description: 'User prompt describing the task to perform'
        required: false
        type: string
        default: |
          Analyze the codebase and provide a summary of the project structure.
      copilot_cli_properties:
        description: 'Contents of the copilot-cli.properties configuration file'
        required: false
        type: string
        default: |
          # GitHub Copilot CLI Configuration Properties
          # Core Configuration
          copilot.model=claude-sonnet-4.5
          auto.install.cli=true
          
          # Tool Permissions
          allow.all.tools=true
          allow.all.paths=false
          
          # Directory Access
          working.directory=.
          
          # Logging and Execution
          log.level=info
          timeout.minutes=30
          node.version=22
    outputs:
      copilot_output:
        description: 'The output from GitHub Copilot CLI execution'
        value: ${{ jobs.run-copilot.outputs.copilot_output }}

  workflow_dispatch:
    inputs:
      agent:
        description: 'Name of the built-in agent to use (e.g., code-review, security-analysis, documentation-generation)'
        required: false
        type: string
        default: ''
      agent_file:
        description: 'Path to a custom .agent.md file (alternative to using a built-in agent)'
        required: false
        type: string
        default: ''
      user_prompt:
        description: 'User prompt describing the task to perform'
        required: false
        type: string
        default: |
          Analyze the codebase and provide a summary of the project structure.
      copilot_cli_properties:
        description: 'Contents of the copilot-cli.properties configuration file'
        required: false
        type: string
        default: |
          # GitHub Copilot CLI Configuration Properties
          # Core Configuration
          copilot.model=claude-sonnet-4.5
          auto.install.cli=true
          
          # Tool Permissions
          allow.all.tools=true
          allow.all.paths=false
          
          # Directory Access
          working.directory=.
          
          # Logging and Execution
          log.level=info
          timeout.minutes=30
          node.version=22

jobs:
  run-copilot:
    name: Run Copilot CLI
    runs-on: ubuntu-latest
    outputs:
      copilot_output: ${{ steps.run-copilot-cli.outputs.copilot_output }}

    env:
      # IMPORTANT: The default GITHUB_TOKEN does not have Copilot access.
      # You must create a secret named COPILOT_PAT with a Personal Access Token
      # that has the 'copilot' scope enabled.
      # Create at: https://github.com/settings/tokens ‚Üí Fine-grained tokens ‚Üí Copilot
      GITHUB_TOKEN: ${{ secrets.COPILOT_PAT }}
      GH_TOKEN: ${{ secrets.COPILOT_PAT }}
      COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_PAT }}

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Setup Node.js 22 (required by Copilot CLI)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # Step 3: Install Copilot CLI Automation Suite
      - name: Install Copilot CLI Automation Suite
        shell: bash
        env:
          INSTALL_SCRIPT_URL: https://raw.githubusercontent.com/neildcruz/copilot-cli-automation-accelerator/main/install.sh
        run: |
          echo "üì¶ Downloading and running install script..."
          
          # Download and execute install script with authentication
          curl -fsSL -H "Authorization: Bearer $GITHUB_TOKEN" "$INSTALL_SCRIPT_URL" | bash
          
          echo "‚úÖ Copilot CLI Automation Suite installed successfully"
          
          # Write the copilot-cli.properties configuration
          echo "üìù Writing copilot-cli.properties configuration..."
          cat << 'EOF' > .copilot-cli-automation/automation/copilot-cli.properties
          ${{ inputs.copilot_cli_properties }}
          EOF
          
          echo "‚úÖ Configuration written successfully"
          
          # Verify installation
          echo "üîç Verifying installation..."
          ls -la .copilot-cli-automation/automation/

      # Step 4: Run Copilot CLI with prompts
      - name: Run Copilot CLI
        id: run-copilot-cli
        shell: bash
        run: |
          echo "üöÄ Running GitHub Copilot CLI..."
          
          # Navigate to the automation directory
          cd .copilot-cli-automation/automation
          
          # Make script executable
          chmod +x copilot-cli.sh
          
          # Create temporary file for user prompt to handle multi-line content
          USER_PROMPT_FILE=$(mktemp)
          
          cat << 'USER_EOF' > "$USER_PROMPT_FILE"
          ${{ inputs.user_prompt }}
          USER_EOF
          
          # Build the copilot-cli.sh command with appropriate flags
          # Capture output to both console and variable
          OUTPUT_FILE=$(mktemp)
          
          AGENT_ARGS=""
          if [ -n "${{ inputs.agent }}" ]; then
            AGENT_ARGS="--agent ${{ inputs.agent }}"
          fi
          if [ -n "${{ inputs.agent_file }}" ]; then
            AGENT_ARGS="$AGENT_ARGS --agent-file ${{ inputs.agent_file }}"
          fi
          
          ./copilot-cli.sh \
            $AGENT_ARGS \
            --prompt-file "$USER_PROMPT_FILE" \
            --config copilot-cli.properties \
            --verbose 2>&1 | tee "$OUTPUT_FILE"
          
          EXIT_CODE=${PIPESTATUS[0]}
          
          # Clean up temp files
          rm -f "$USER_PROMPT_FILE"
          
          # Read and set output
          # GitHub Actions has a limit on output size, so we truncate if necessary
          OUTPUT=$(cat "$OUTPUT_FILE")
          rm -f "$OUTPUT_FILE"
          
          # Set output using GITHUB_OUTPUT (handles multi-line)
          {
            echo 'copilot_output<<COPILOT_OUTPUT_EOF'
            echo "$OUTPUT"
            echo 'COPILOT_OUTPUT_EOF'
          } >> "$GITHUB_OUTPUT"
          
          echo "‚úÖ Copilot CLI execution completed with exit code: $EXIT_CODE"
          
          exit $EXIT_CODE
