name: PR Code Review with Copilot

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number'
        required: true
        type: number
  
  pull_request_target:
    types: [labeled]

jobs:
  review-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Check for copilot-review label
        if: github.event_name == 'pull_request_target'
        run: |
          echo "::group::Label Check"
          labels='${{ toJson(github.event.pull_request.labels.*.name) }}'
          echo "PR Labels: $labels"
          
          if echo "$labels" | grep -q "copilot-review"; then
            echo "âœ… 'copilot-review' label found - proceeding with review"
          else
            echo "â­ï¸ 'copilot-review' label not found - skipping review"
            echo "::notice::Workflow triggered but 'copilot-review' label not present. Add the label to trigger a review."
            exit 0
          fi
          echo "::endgroup::"

      - name: Set PR Number
        id: set-pr
        run: |
          if [ "${{ github.event_name }}" == "pull_request_target" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "ðŸ“Œ Triggered by PR #${{ github.event.pull_request.number }}"
          else
            echo "pr_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
            echo "ðŸ“Œ Manually triggered for PR #${{ github.event.inputs.pr_number }}"
          fi

      - name: Validate Environment
        run: |
          echo "::group::Environment Validation"
          echo "Repository: ${{ github.repository }}"
          echo "PR: #${{ steps.set-pr.outputs.pr_number }}"
          echo "::endgroup::"

      - name: Install Node.js and Copilot CLI
        run: |
          echo "::group::Installing Prerequisites"
          
          # Install Node.js v22 (required for Copilot CLI)
          curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
          sudo apt-get install -y nodejs jq
          
          # Verify Node.js version
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          
          # Install GitHub Copilot CLI globally
          sudo npm install -g @github/copilot
          
          echo "âœ… Copilot CLI installed"
          echo "::endgroup::"

      - name: Fetch Pull Request Details
        id: fetch-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Fetching PR Details"
          pr_data=$(gh api repos/${{ github.repository }}/pulls/${{ steps.set-pr.outputs.pr_number }})
          
          pr_title=$(echo "$pr_data" | jq -r '.title')
          pr_body=$(echo "$pr_data" | jq -r '.body // ""')
          pr_state=$(echo "$pr_data" | jq -r '.state')
          pr_author=$(echo "$pr_data" | jq -r '.user.login')
          pr_head_sha=$(echo "$pr_data" | jq -r '.head.sha')
          pr_base_branch=$(echo "$pr_data" | jq -r '.base.ref')
          pr_head_branch=$(echo "$pr_data" | jq -r '.head.ref')
          
          echo "title=$pr_title" >> $GITHUB_OUTPUT
          echo "state=$pr_state" >> $GITHUB_OUTPUT
          echo "author=$pr_author" >> $GITHUB_OUTPUT
          echo "head_sha=$pr_head_sha" >> $GITHUB_OUTPUT
          echo "base_branch=$pr_base_branch" >> $GITHUB_OUTPUT
          echo "head_branch=$pr_head_branch" >> $GITHUB_OUTPUT
          
          echo "âœ“ Fetched PR: $pr_title"
          echo "  State: $pr_state"
          echo "  Author: $pr_author"
          echo "  Base: $pr_base_branch â†’ Head: $pr_head_branch"
          echo "  Head SHA: $pr_head_sha"
          echo "::endgroup::"

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.fetch-pr.outputs.head_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch PR Diff and Changed Files
        id: fetch-diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Fetching PR Diff"
          
          # Get the list of changed files
          files_data=$(gh api repos/${{ github.repository }}/pulls/${{ steps.set-pr.outputs.pr_number }}/files)
          
          # Save complete diff to file
          gh api repos/${{ github.repository }}/pulls/${{ steps.set-pr.outputs.pr_number }} \
            -H "Accept: application/vnd.github.v3.diff" > /tmp/pr_diff.patch
          
          # Extract changed file paths
          echo "$files_data" | jq -r '.[].filename' > /tmp/changed_files.txt
          
          file_count=$(echo "$files_data" | jq 'length')
          additions=$(echo "$files_data" | jq '[.[].additions] | add')
          deletions=$(echo "$files_data" | jq '[.[].deletions] | add')
          
          echo "file_count=$file_count" >> $GITHUB_OUTPUT
          
          echo "âœ“ PR Statistics:"
          echo "  Files changed: $file_count"
          echo "  Additions: +$additions"
          echo "  Deletions: -$deletions"
          echo ""
          echo "Changed files:"
          cat /tmp/changed_files.txt
          echo "::endgroup::"

      - name: Test Copilot Authentication
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN }}
        run: |
          echo "::group::Testing Copilot Authentication"
          
          if [ -z "$COPILOT_GITHUB_TOKEN" ]; then
            echo "::error::COPILOT_GITHUB_TOKEN is not set"
            exit 1
          fi
          
          echo "âœ“ COPILOT_GITHUB_TOKEN is set (length: ${#COPILOT_GITHUB_TOKEN})"
          
          # Test Copilot with simple prompt
          echo "Testing Copilot CLI..."
          echo "What is 2+2?" | timeout 15 copilot 2>&1 | tee /tmp/copilot_test.log
          TEST_EXIT=${PIPESTATUS[1]}
          
          if [ $TEST_EXIT -eq 0 ]; then
            echo "âœ… Copilot CLI authenticated and working"
          else
            echo "::error::Copilot CLI test failed (exit code: $TEST_EXIT)"
            exit 1
          fi
          
          echo "::endgroup::"

      - name: Analyze Code with Copilot
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN }}
        run: |
          echo "::group::Copilot Code Review"
          
          # Read the diff
          diff_content=$(cat /tmp/pr_diff.patch)
          changed_files=$(cat /tmp/changed_files.txt | tr '\n' ', ' | sed 's/,$//')
          
          prompt="You are an expert code reviewer. Please review the following pull request changes and provide a comprehensive code review.

          PR #${{ steps.set-pr.outputs.pr_number }}: ${{ steps.fetch-pr.outputs.title }}
          Files changed: $changed_files

          Here is the full diff:
          \`\`\`diff
          ${diff_content}
          \`\`\`

          Please analyze the code changes and provide:
          1. **Overall Assessment**: Brief summary of the changes
          2. **Code Quality**: Rate the code quality and adherence to best practices
          3. **Potential Issues**: List any bugs, security concerns, or performance issues
          4. **Suggestions**: Specific improvements or recommendations
          5. **Positive Aspects**: What was done well

          Format your review in markdown with clear sections. Be constructive and specific."
          
          echo "â³ Copilot is analyzing the code changes (timeout: 5 minutes)..."
          
          # Get review from Copilot
          set +e
          echo "$prompt" | timeout 300 copilot 2>&1 | tee /tmp/copilot_review.txt
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 124 ]; then
            echo "::warning::Copilot analysis timed out after 5 minutes"
            echo "âš ï¸ Code review timed out. Please review manually." > /tmp/copilot_review.txt
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "::warning::Copilot exited with code $EXIT_CODE"
            echo "âš ï¸ Code review encountered an error. Please review manually." > /tmp/copilot_review.txt
          else
            echo "âœ“ Copilot review completed successfully"
          fi
          
          echo "::endgroup::"

      - name: Post Review Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Posting Review Comment"
          
          review_content=$(cat /tmp/copilot_review.txt)
          
          # Create a review comment body
          comment_body="## ðŸ¤– Automated Code Review by GitHub Copilot

          $review_content

          ---
          *This review was automatically generated by GitHub Copilot CLI*
          *Review Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*"
          
          # Save comment to file for proper escaping
          echo "$comment_body" > /tmp/review_comment.txt
          
          # Post comment to PR
          gh pr comment ${{ steps.set-pr.outputs.pr_number }} \
            --body-file /tmp/review_comment.txt
          
          echo "âœ“ Review comment posted to PR #${{ steps.set-pr.outputs.pr_number }}"
          echo "::endgroup::"
          
          echo "::notice::âœ… Code review completed and posted to PR #${{ steps.set-pr.outputs.pr_number }}"

      - name: Create Review Summary
        run: |
          echo "::group::Review Summary"
          echo "ðŸ“Š Review completed successfully!"
          echo ""
          echo "PR Details:"
          echo "  Number: #${{ steps.set-pr.outputs.pr_number }}"
          echo "  Title: ${{ steps.fetch-pr.outputs.title }}"
          echo "  Author: ${{ steps.fetch-pr.outputs.author }}"
          echo "  Files Changed: ${{ steps.fetch-diff.outputs.file_count }}"
          echo ""
          echo "Review has been posted as a comment on the pull request."
          echo "::endgroup::"